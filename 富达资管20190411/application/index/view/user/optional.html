{extend name="layouts/layout_user" /}

{block name="title"}
自选
{/block}

{block name="style"}
<style type="text/css">
    body{
        background: #f5f5f5 !important;
    }
    .zixuan_list{
        margin-bottom: 110px;
    }
    .delete_panel{
        display: none;
    }
    * {
        -webkit-user-select: auto!important;
    }
    .search_con input {
        width: 100%;
        height: 46px;
        line-height: 46px;
        padding-left: 40px;
        background-size: 20px 20px;
        border: none;
        border-radius: 3px;
        font-size: 16px;
        color: #333;
        padding-right: 30px;
    }
    body{
        padding-bottom: 50px;
    }
    .edit_btn {
        background-size: 100%;
        top: 20px;
        right: 18px;
    }
    #zfb_ul{margin-bottom: 10px}
    .Ashare_top{margin-bottom: 8px}
    #pxlist .tit{padding-left:18px;font-size: 15px }
    /*Ashare*/
.Ashare{
    background-color: #fff;
}
ul.Ashare_top{
    padding: 0 15px;
}
.Ashare_top li{
    width: 33%;
    padding: 0 10px;
}
.Ashare_top li:nth-of-type(2){
    border-left: 1px solid #DADADA;
    border-right: 1px solid #DADADA;
}
.Ashare_t{
    margin-bottom: 5px;
    font-size: 13px;
}
.Ashare_num{
    font-size: 20px;
    margin-bottom: 6px;
}
.per span{
    font-size: 12px;
}
.Ashare_bot{
    border-top: 1px solid #DADADA;
    line-height: 55px;
    padding: 0 10px;
}
.Ashare_balanceBox{
    font-size: 12px;
}
#balance{
    font-size: 18px;
}
.buy_a{
        display: inline-block;
    width: inherit;
    font-size: 14px;
    padding: 5px 10px;
    background: red;
    color: #fff;
    border: none;
    margin-top: 12px;
    padding: 3px 0;
}
ul.gift_box{
    margin: 0;
    text-align: center;
}
ul.gift_box li img{
    width: 35px;
    margin-bottom: 2px;
}
ul.gift_box li p{
    color: #444445;
}
.dr_p{
    height: 40px !important;
    line-height: 40px !important;
    font-size: 12px;
    background: #fff;
    padding-left: 10px;
    border-bottom: 1px solid #DADADA !important;
    font-size: 14px;
    padding-top: 0px !important;
}
#buy_a{
    display: inline-block;
    background: #e60012;
    width: 70px;
    font-size: 12px;
    text-align: center;
    color: #fff;
    line-height: 25px;
}
.icon-dr{
    display: inline-block;
    background-image: url(../img/dr.png);
    background-size: 100%;
    width: 16px;
    height: 16px;
    vertical-align: middle;
    margin-right: 8px;
}
/*activity*/
.activity ul{
    background-color: #fff;
    margin: 0;
    padding: 0 10px 20px;
}
.activity li{
    height: 60px;
line-height: 20px;
padding-top: 10px;
font-size: 12px;
border-bottom: 1px solid #DADADA
}
.activity li:last-of-type{
    border-bottom:none
}
.user_ProfitOrLossNum{
    color: #FD9A26;
}
.gift_box{
    background: #fff;
    margin-bottom: 8px!important;
    padding-top: 14px;
}
.Ashare_top li {
    padding-top: 10px;
    height: 88px;
    border-left: none!important;
    border-right:none!important;
}
.Ashare_top li+li{
    border-left: 1px solid #dadada!important;
}
.add_item{
    display: block;
    height: 100%;
    background: url(../img/add_items.png) no-repeat center center;
    background-size: 110%;
}
.clear_fl:after{
    content:"";
    display: block;
    clear: both;
}
.lf{
    float: left;
}
.rt{
    float: right;
}
.flex_none{
    -moz-box-flex: none; /*Firefox*/
    -webkit-box-flex: none; /*Safari,Opera,Chrome*/
    -webkit-box-flex: none;
    -webkit-flex: none;
    -ms-flex: none;
    flex:none;
}
.flex_nowrap{
    display:flex;
    display: -webkit-box; /* OLD - iOS 6-, Safari 3.1-6 */ 
    display: -moz-box; /* OLD - Firefox 19- (buggy but mostly works) */ 
    display: -ms-flexbox; /* TWEENER - IE 10 */ 
    display: -webkit-flex; /* NEW - Chrome */ 
    -webkit-flex-wrap: nowrap;
    -moz-flex-wrap: nowrap;
    -ms-flex-wrap: nowrap;
    -o-flex-wrap: nowrap;
    flex-wrap: nowrap;
}
.per span{font-size: 12px}
#pxlist{display: none;}
</style>
    <link rel="stylesheet" type="text/css" href="__RESOURCE__/css/swiper.min.css">
{/block}

{block name="body"}
<body class="  mui-ios mui-ios-10 mui-ios-10-3">
{/block}

{block name="content"}
    <header class="strategy_top">
        <p>
            <a href="javascript:zxtab(0);" class="active" id="zxtab0">自选</a>
            <a href="javascript:zxtab(1);" id="zxtab1">沪深</a>
        </p>
    </header>
    <div class="search_con">
        <input styel="-webkit-user-select:auto" id="searchInput" placeholder="请输入股票代码/名称">
        <span class="edit_btn"></span>
    </div>
<section class="Ashare">
			<div class="Ashare_top">
				<div class="slid-container swiper-container swiper-container-horizontal swiper-container-free-mode">
		        
		            <ul class="swiper-wrapper">
		            	<li class="swiper-slide mui-text-center">
		                    <p class="home__quo-name___1C8w0">上证指数</p>
							<p class="Ashare_num color color_red" id="index_shzs_1">0</p>
							<div class="per mui-clearfix">
								<span class="mui-pull-left color color_red">0</span>
								<span class="mui-pull-right color color_red">0</span>
							</div>
		                </li>
		                <li class="swiper-slide mui-text-center">
		                    <p class="home__quo-name___1C8w0">深证成指数</p>
							<p class="Ashare_num color color_red">0</p>
							<div class="per mui-clearfix">
								<span class="mui-pull-left color color_red">0</span>
								<span class="mui-pull-right color color_red">0</span>
							</div>
		                </li>
		                <li class="swiper-slide mui-text-center">
		                		<p class="home__quo-name___1C8w0">创业板指</p>
								<p class="Ashare_num color color_red">0</p>
								<div class="per mui-clearfix">
									<span class="mui-pull-left color color_red">0</span>
									<span class="mui-pull-right color color_red">0</span>
								</div>
		   
		                </li>
					</ul>
				</div>
				</div>
			</section>
    <ul class="zixuan_list" id="zixuan_list">
        <li class="list_header flex_nowrap">
            <div class="select_btn" style="width:15%">
            </div>
            <span style="width:40%;padding-left: 18px">名称代码</span>
            <span style="width:20%">现价</span>
            <span style="width:20%">涨跌幅</span>
            <span style="width:20%"></span>
        </li>
        {volist name="stocks" id="item"}
        <li class="list_header flex_nowrap" data-code="{$item.code}">
            <div style="width:15%" class="mui-input-row mui-checkbox mui-left select_btn">
                <label></label>
                <input name="checkbox" value="{$item.id}" type="checkbox">
            </div>
            <a style="width:80%" class="flex_nowrap" href="{:url('index/Stock/info', ['code' => $item.code])}">
                <span class="zi_name" style="width:80%;padding-left: 18px;"> <span>{$item.quotation.prod_name}</span><span>{$item.quotation.code}</span></span>
                {if condition="$item.quotation.px_change EGT 0"}
                <span style="width:40%" class="red">{$item.quotation.last_px}</span>
                <span style="width:40%" class="red">{$item.quotation.px_change_rate}%</span>
                {else /}
                <span style="width:40%" class="green">{$item.quotation.last_px}</span>
                <span style="width:40%" class="green">{$item.quotation.px_change_rate}%</span>
                {/if}
            </a>
            <span style="width:20%">
                <a href="{:url('index/Stock/stockBuy', ['code' => $item.code])}" class="mui-btn mui-btn-success mui-btn-outlined">添加自选</a>
            </span>
        </li>
        {/volist}
    </ul>

    <div id="pxlist">
    <ul class="zixuan_list" id="zfb_ul">
</ul>

<ul class="zixuan_list" id="dfb_ul">
        
</ul>
    </div>
    <div class="delete_panel clear_fl">
        <!-- <div id="allChecked" style="display: none;float: left;height: 32px;" class="mui-input-row mui-checkbox mui-left select_btn">
            <label></label>
            <input name="checkbox" value="Item 1" type="checkbox">
        </div> -->
        <button class="rt zixun_delete_btn">删除</button>
    </div>
{/block}

{block name="nav"}
    <nav class="ml_tab mui-bar mui-bar-tab">
        <a class="mui-tab-item" href="{:url('index/Index/index')}">
            <span class="mui-icon mui-icon-home"></span>
            <span class="mui-tab-label">首页</span>
        </a>
        <a class="mui-tab-item mui-active" href="javascript:void(0);">
            <span class="mui-icon mui-icon-zixuan"></span>
            <span class="mui-tab-label">自选</span>
        </a>
        <a class="mui-tab-item center_item" href="{:url('index/Ai/index')}">
            <span class="mui-icon mui-icon-celue"></span>
            <span class="mui-tab-label">AI智能策略</span>
        </a>
        <a class="mui-tab-item" href="{:url('index/Strategy/index')}">
            <span class="mui-icon mui-icon-jingu"></span>
            <span class="mui-tab-label">策略</span>
        </a>
        <a class="mui-tab-item" href="{:url('index/User/index')}">
            <span class="mui-icon mui-icon-my"></span>
            <span class="mui-tab-label">我的</span>
        </a>
    </nav>
{/block}

{block name="script"}
<script type="text/javascript" src="__STATIC__/js/stock.js"></script>
<script type="text/javascript" src="__RESOURCE__/js/common.js"></script>
<script type="text/javascript">
    /**
 * 判断当前时间是否在9:30-11:30, 13:00-15:00（交易时间）
 */
function isTradingTime(){
    var date = new Date();
    //判断是不是周末
    var dt=date.getDay();
    if(dt=='6'||dt=='7'){
        return false;
    }
    //判断当前时间是否在9:30-11:30, 13:00-15:00
    var h = date.getHours();
    var mi = date.getMinutes();
    var s = date.getSeconds();
    if(h < 10){
        h = "0" + h;
    }
    if(mi < 10){
        mi = "0"+ mi;
    }
    if(s < 10){
        s = "0" + s;
    }
    var curTime = h + ":" + mi + ":" + s;
//  console.log(curTime);
    if( curTime >= "09:30:00" && curTime <= "11:30:00" || curTime >= "13:00:00" && curTime <= "15:00:00" ){
        return true;
    }
    return false;
}



    var refreshTimer = null;
	$(".edit_btn").on("tap" , function(){
        if( $("#searchInput").val() != "" || $(".zixuan_list li").length == 1 ){
            return false;
        }
		$(".select_btn").toggle();
        $(".delete_panel").toggle();
        $(this).toggleClass("active");

        if( $(this).hasClass("active") ){
            if( refreshTimer ){
                clearInterval( refreshTimer );
                refreshTimer = null;
            }
        }else{
            refreshTimer =setInterval(refreshPrice,2000);
        }
	});

	mui.init({
		swipeBack: true //启用右滑关闭功能
	})

	//选项卡
	 mui('body').on('tap', 'a', function() {
        var data_href = this.getAttribute("data-href");
        var href = this.getAttribute("href");
        var url=data_href;
        if(!url||url==''){
            url=href;
        }
        window.location.href = url;
     });

    $("#searchInput").keyup(function(){
        var val = $(this).val();
        displayItems(val);
    });

    var listCon = $(".zixuan_list").html();
    function displayItems(items) {
        var code = new Array();
        html='<li class="list_header flex_nowrap">\
            <div class="select_btn" style="width: 15%; display: none;">\
            </div>\
            <span style="width:40%;padding-left: 18px">名称代码</span>\
            <span style="width:20%">现价</span>\
            <span style="width:20%">涨跌幅</span>\
            <span style="width:20%"></span>\
        </li>';
        if (items==''){ //搜索结果为空， 置空列表
            html=listCon;
            $(".zixuan_list").html( html );
            refreshTimer =setInterval(refreshPrice,2000);
        }else{
            if( refreshTimer ){
                clearInterval( refreshTimer );
                refreshTimer = null;
            }
            var j = 0;
            for (var i = 0; i < stocks.length; i++) {
                var reg = new RegExp('^' + items + '.*$', 'im');
                if (reg.test(stocks[i][0]) || reg.test(stocks[i][1]) || reg.test(stocks[i][2]) || reg.test(stocks[i][3])) {
                    if(j < 15){
                        code.push( stocks[i][1] );
                        j++;
                    }else{
                        break;
                    }
                }
            }

            if(code.length == 0){
                var html = '<li class="no_more"></li><li style="text-align:center;font-size:12px;color:#999;background:transparent;border:none;">暂无搜索结果</li>';
                $(".zixuan_list").html( html );
            }

            code = code.join(",");
            var _url = "{:url('index/Stock/simple')}",
                _oData = {code: code};
            $ajaxCustom(_url, _oData, function(res){
			console.log(res);
                if(res.state){ // 登录成功
                    for( var key in res.data ){
                        var rate = parseFloat(res.data[key].px_change_rate);
                        var className = "";
                        if(rate >= 0){
                            className = "red"
                        }else{
                            className = "green"
                        }
                        html += '<li class="list_header flex_nowrap">\
                                    <div style="width: 15%; display: none;" class="mui-input-row mui-checkbox mui-left select_btn">\
                                        <label></label>\
                                        <input name="checkbox" value="Item 1" type="checkbox">\
                                    </div>\
                                        <span class="zi_name" style="width:80%;padding-left: 18px;"> <span>'+ res.data[key].prod_name +'</span><span>' + res.data[key].code + '</span></span>\
                                        <span style="width:40%" class="' + className + '">' + res.data[key].last_px + '</span>\
                                        <span style="width:40%" class="' + className + '">' + res.data[key].px_change_rate + '%</span>\
                                    <span style="width:20%">\
                                        <a href="" class="mui-btn mui-btn-success mui-btn-outlined">创建策略</a>\
                                    </span>\
                                </li>';
                    }
                    $(".zixuan_list").html( html );
                }else{
                    // $alert(res.info);
                }
            });
        }
    }

    //实时更新
    refreshTimer =setInterval(refreshPrice,2000);
    function refreshPrice(){
        if( !isTradingTime() ){
            return false;
        }
        var code = new Array();
        if( $(".zixuan_list li+li").length > 0 ){
            var html='<li class="list_header flex_nowrap">\
                <div class="select_btn" style="width: 15%; display: none;">\
                </div>\
                <span style="width:40%;padding-left: 18px">名称代码</span>\
                <span style="width:20%">现价</span>\
                <span style="width:20%">涨跌幅</span>\
                <span style="width:20%"></span>\
            </li>';
            $(".zixuan_list li+li").each(function(){
                var _code = $(this).find(".zi_name").find("span+span").html();
                code.push( _code );
            });

            code = code.join(",");
            var _url = "{:url('index/Stock/simple')}",
                _oData = {code: code};
            $ajaxCustom(_url, _oData, function(res){
			console.log(res);
                if(res.state){ // 登录成功
                    if( $(".edit_btn").hasClass("active") ){
                        return false;
                    }
                    for( var key in res.data ){
                        var rate = parseFloat(res.data[key].px_change_rate);
                        var className = "";
                        if(rate >= 0){
                            className = "red"
                        }else{
                            className = "green"
                        }
                        html += '<li class="list_header flex_nowrap">\
                                    <div style="width: 15%; display: none;" class="mui-input-row mui-checkbox mui-left select_btn">\
                                        <label></label>\
                                        <input name="checkbox" value="Item 1" type="checkbox">\
                                    </div>\
                                    <a style="width:80%" class="flex_nowrap" href="/stock/home.html?code='+ res.data[key].code +'">\
                                        <span class="zi_name" style="width:80%;padding-left: 18px;"> <span>'+ res.data[key].prod_name +'</span><span>' + res.data[key].code + '</span></span>\
                                        <span style="width:40%" class="' + className + '">' + res.data[key].last_px + '</span>\
                                        <span style="width:40%" class="' + className + '">' + res.data[key].px_change_rate + '%</span>\
                                        \
                                    </a>\
                                    <span style="width:20%">\
                                        <a href="" class="mui-btn mui-btn-success mui-btn-outlined">创建策略</a>\
                                    </span>\
                                </li>';
                    }
                    $(".zixuan_list").html( html );
                }else{
                    // $alert(res.info);
                }
            });
        }
    }

    // 删除自选
    $(".zixun_delete_btn").click(function(){
        if($(".zixuan_list li+li").length > 0){
            var code = new Array();
            $(".zixuan_list li+li").each(function(){
                if( $(this).find("input").is(":checked") ){
                    var _code = $(this).find(".zi_name span+span").html();
                    code.push(_code);
                }
            });
            if(code.length == 0){
                return false;
            }
            var _url = '{:url("index/User/removeOptional")}',
                _oData = {ids: code};
            $ajaxCustom(_url, _oData, function(res){
                if(res.state){ // 登录成功
                    $alert("操作成功！");
                    setTimeout(function () {
                        window.location.reload();
                    }, 500);
                }else{
                    $alert(res.info);
                }
            });
        }
        
    });



    //搜索历史
        $("body").on("click", ".zixuan_list li", function(){
            var code = $(this).find(".zi_name span+span").html();
            var storage = window.localStorage;
            if( storage.searchHistory ){
                var searchHistory = storage.searchHistory;
                searchHistory = searchHistory.split(",");
                var index = searchHistory.indexOf(code);
                if (index > -1) {
                    searchHistory.splice(index, 1);
                }
                if( searchHistory.length >= 10 ){
                    searchHistory.splice(8, searchHistory.length - 9);
                }
                searchHistory.unshift( code );
                searchHistory = searchHistory.join(",");
                storage.searchHistory = searchHistory;
            }else{
                storage.searchHistory = code;
            }
            window.location.href = "/stock/home.html?code=" + code;
        });


function loadZhiPrice(){
            var _url = "/plate.json?" + Math.random(),
                _oData = {};
            $.getJSON(_url,function(_data,status){
                
                var html = "";
                for( var key in _data ){
                    var className =  "";
                    if( _data[key].px_change >= 0 ){
                        className = "red";
                    }else{
                        className = "green";
                    }
                    html += '<li class="swiper-slide mui-text-center">\
                            <a href="">\
                                <p class="Ashare_t">'+ _data[key].plate_name +'</p>\
                                <p class="Ashare_num color ' + className + '">'+ (_data[key].last_px * 10 / 10).toFixed(2) +'</p>\
                                <div class="per mui-clearfix">\
                                    <span class="mui-pull-left color ' + className + '">'+ _data[key].px_change +'</span>\
                                    <span class="mui-pull-right color ' + className + '">'+ _data[key].px_change_rate +'%</span>\
                                </div>\
                            </a>\
                        </li>';
                }

                $(".Ashare_top li:nth-child(1)").remove();
                $(".Ashare_top li:nth-child(1)").remove();
                $(".Ashare_top li:nth-child(1)").remove();
                var $dom = $( html );
                $(".Ashare_top ul").prepend( $dom );

            });
        }

        
$(function(){
    
    //loadpxlist();
    loadZhiPrice(); 
    setInterval(function(){
            if( !isTradingTime() ){
                return false;
            }
            loadZhiPrice();
    },4000);
})

function loadpxlist(){
    var url = "/px.json?" + Math.random();
    $.get(url,function(data,status){
        var len = data.zfpx.length;
                var html = [];
                html[0] = '<li class="list_header flex_nowrap tit">涨幅榜</li>';
                for (var i = 0; i<len; i++) {
                    html[html.length]='<li class="list_header flex_nowrap"><span class="zi_name" style="width:80%;padding-left: 18px;"><span>';
                    html[html.length]=data.zfpx[i].name;
                    html[html.length]='</span><span>';
                    html[html.length]=data.zfpx[i].code;
                    html[html.length]='</span></span><span style="width:40%" class="red">';
                    html[html.length]=data.zfpx[i].trade;
                    html[html.length]='</span><span style="width:40%" class="red">';
                    html[html.length]=data.zfpx[i].changepercent;
                    html[html.length]='%</span></li>';
                }
                html = html.join('');
                $('#zfb_ul').html(html);
                len = data.dfpx.length;
                html = [];
                html[0] = '<li class="list_header flex_nowrap tit">涨幅榜</li>';
                for (var i = 0; i<len; i++) {
                    html[html.length]='<li class="list_header flex_nowrap"><span class="zi_name" style="width:80%;padding-left: 18px;"><span>';
                    html[html.length]=data.dfpx[i].name;
                    html[html.length]='</span><span>';
                    html[html.length]=data.dfpx[i].code;
                    html[html.length]='</span></span><span style="width:40%" class="green">';
                    html[html.length]=data.dfpx[i].trade;
                    html[html.length]='</span><span style="width:40%" class="green">';
                    html[html.length]=data.dfpx[i].changepercent;
                    html[html.length]='%</span></li>';
                }
                html = html.join('');
                $('#dfb_ul').html(html);
				$('#dfb_ul .tit').click(function(){return false;});
				$('#zfb_ul .tit').click(function(){return false;});

                
    });
}
var loading_pxlist = false;
function zxtab(k){
    if (k == 0) {
        $('#zixuan_list').show();
        loading_pxlist = false;
        $('#pxlist').hide();
        $('#zxtab1').removeClass('active');
        $('#zxtab0').addClass('active');
    }else{
        $('#zxtab0').removeClass('active');
        $('#zxtab1').addClass('active');
        $('#zixuan_list').hide();
        $('#pxlist').show();
        loading_pxlist = true;
        loadpxlist();
    }
}
</script>
{/block}